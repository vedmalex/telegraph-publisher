# Product Requirements - telegraph-publisher

## 1. Project Overview

- CLI-инструмент для:
  - публикации Markdown-контента в Telegra.ph;
  - управления зависимостями между файлами (книга как дерево Markdown-документов);
  - валидации и ремонта ссылок;
  - экспорта в форматы чтения (EPUB, в перспективе AZW3 и др.).
- Основной сценарий: «у меня есть дерево `.md` файлов (книга/сборник) → хочу:
  - последовательно публиковать/обновлять главы в Telegra.ph с метаданными и кэшем;
  - собрать целиком оффлайн-книгу (EPUB/AZW3) с корректной навигацией и ссылками».

## 2. Целевые пользователи и сценарии

- **Автор / переводчик книг**
  - Пишет книгу в Markdown с разбиением по файлам и папкам.
  - Хочет:
    - публиковать главы в Telegra.ph с сохранением структуры;
    - собирать оффлайн-книгу (EPUB/AZW3) «одной командой».

- **Технический редактор / девелопер**
  - Поддерживает много Markdown-проектов.
  - Хочет:
    - проверять и чинить ссылки;
    - управлять зависимостями и порядком публикации;
    - анализировать и отлаживать пайплайн через debug-артефакты (`*.json`, `*.epub.json`).

## 3. Основные возможности

### 3.1 Публикация в Telegra.ph

- Unified команда `publish`:
  - создание и обновление страниц с единым интерфейсом;
  - поддержка фронт-маттера (`title`, `telegraphUrl`, `editPath`, `contentHash`, `publishedDependencies`, `accessToken`).
- Управление зависимостями:
  - построение дерева зависимостей по локальным Markdown-ссылкам;
  - выборочное или полное перепубликовывание при изменениях;
  - хранение `publishedDependencies` в метаданных для последующих проходов.
- Кэш:
  - `.telegraph-pages-cache.json` с маппингом «локальный путь ↔ Telegra.ph URL»;
  - использование кэша для восстановления метаданных и ускорения повторных проходов.

### 3.2 Работа со ссылками

- Поиск локальных ссылок и их классификация:
  - локальные `.md` / `.markdown`;
  - внешние HTTP(S), mailto, tel;
  - якоря `#anchor`.
- Валидация:
  - проверка существования целевых файлов;
  - поиск битых ссылок и генерация отчётов.
- Ремонт:
  - предложения исправлений (по имени файла и структуре каталогов);
  - опциональные авто-фиксы и интерактивный режим.

### 3.3 EPUB (книга из Markdown-дерева)

- Вход:
  - один или несколько root-файлов (`-f`), каждый может быть индексом уровня;
  - дерево Markdown-ссылок любой сложности (вложенность, перекрёстные ссылки).
- Порядок глав:
  - слой 0 — все root-файлы в порядке CLI;
  - слой 1 — все уникальные `.md`-файлы, на которые ссылаются root'ы;
  - слой 2 — зависимости файлов слоя 1, и т.д.;
  - каждый файл включается в книгу **ровно один раз**.
- Ссылки:
  - переписывание ссылок вида `./XXX.md[#anchor]` → `chapter-N.html[#anchor]`;
  - чистые `#anchor` внутри главы не трогаются;
  - внешние ссылки остаются как есть.
- Содержимое:
  - преобразование Markdown в TelegraphNode (общий конвертер);
  - сохранение многострочных абзацев как единого блока `p` с `\n` внутри;
  - корректные заголовки и ToC (внутриглавный и глобальный).
- Отладка:
  - при `--debug` сохранение:
    - временной EPUB-структуры (`.epub-temp-*`);
    - `*.epub.json` (TelegraphNode-модель для каждой главы).

### 3.4 Будущие расширения (AZW3 и др.)

- Опциональный шаг: конвертация готового EPUB в AZW3:
  - через внешний инструмент (`ebook-convert` / Calibre) при наличии;
  - аккуратная деградация: если конвертер не установлен, EPUB остаётся основным артефактом.
- Возможность добавления других конвертеров без изменения ядра (расширяемый слой «post-processing» над EPUB).

## 4. Нефункциональные требования

- **Производительность и масштабируемость**
  - Поддержка крупных книг (десятки/сотни файлов, глубокая вложенность).
  - Проход по дереву зависимостей линейный по числу уникальных файлов (защитa от циклов и экспоненциального роста).

- **Надёжность и восстановление**
  - Любые ошибки сетевых запросов / конвертеров не должны ломать локальную структуру файлов.
  - Отчётливые сообщения об ошибках и debug-артефакты для воспроизводимости.

- **CLI-эргономика**
  - Явные флаги для включения/отключения deps, debug, разных форматов.
  - Конфигурация через `.telegraph-publisher-config.json` + CLI-override.

## 5. Текущий фокус (V1.x)

- EPUB:
  - надёжный слойный порядок глав;
  - переписывание ссылок `.md → chapter-N.html[#anchor]`;
  - адекватная работа на реальных больших проектах (пример ШБ / Песнь1).
- Markdown-конвертер:
  - корректная сборка многострочных абзацев;
  - стабильные заголовки, ToC и якоря.

## 6. Backlog (Initial, High-Level)

- [MEDIUM] TASK-001_EPUB-Chapter-Ordering – ensure EPUB chapters and TOC follow CLI file order while including dependencies once.
- [MEDIUM] TASK-002_Paragraph-Block-Parsing – treat consecutive non-empty lines as a single paragraph block in Markdown converter.
- [HIGH] TASK-003_EPUB-Deep-Tree-Performance – гарантировать линейное по числу файлов время обхода для больших книг, минимизировать зависимость от глубины и циклов.
- [MEDIUM] TASK-004_AZW3-Export-Option – добавить опциональную конвертацию EPUB → AZW3 через внешний инструмент при наличии.

## 7. Источники и контекст

- Код:
  - `src/cli/EnhancedCommands.ts` – CLI, publish/epub-команды.
  - `src/epub/EpubGenerator.ts` – EPUB-пайплайн.
  - `src/markdownConverter.ts` – конвертер Markdown → TelegraphNode.
  - `src/dependencies/DependencyManager.ts`, `src/links/*` – deps и ссылки.
- Практические кейсы:
  - реальные проекты (ШБ / Песнь1, Джайва-дхарма и др.);
  - тестовый стенд `test-epub-nested-sample/` для EPUB.

