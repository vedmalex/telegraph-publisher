---
task_id: TASK-010
task_name: "Link Verification and Auto-Repair Enhancement"
analysis_date: "2025-07-28"
---

# VAN Analysis - Link Verification and Auto-Repair Enhancement

## 1. Введение
Данный документ содержит результаты VAN-анализа для задачи по улучшению проверки и автоматического исправления ссылок в `telegraph-publisher`.

## 2. Обзор текущей ситуации

### 2.1. Существующая логика обработки путей
- `LinkVerifier.ts`: Использует `path.resolve(sourceDir, linkHref)` для относительных путей и `path.resolve(projectRoot, linkHref.slice(1))` для абсолютных. `findProjectRoot` находится внутри `LinkVerifier`.
- `LinkResolver.ts`: Использует `relative(sourceDir, candidateFile)` для предложений. Имеет статические методы `findLocalLinks` и `resolveLocalPath`.
- `DependencyManager.ts`: Использует `resolve(dirname(filePath), link.href)`.
- `ContentProcessor.ts`: Использует `LinkResolver.findLocalLinks`.

### 2.2. Статус проверки и исправления ссылок
- В настоящее время команда `check-links` предоставляет функционал верификации и интерактивного исправления (`InteractiveRepairer`).
- Отсутствует автоматическая проверка перед публикацией и неинтерактивное автоматическое исправление.

## 3. Требования и цели

### 3.1. Унификация разрешения путей (R-1)
- **Цель**: Создать единый, централизованный `PathResolver` для всех операций с файловыми путями.
- **Преимущества**: Улучшение консистентности, упрощение поддержки, повышение тестируемости.
- **Изменения**: Вынесение логики `findProjectRoot` и `resolve` в новый класс, инъекция его в `LinkVerifier`, `DependencyManager`, `LinkResolver` (при необходимости).

### 3.2. Обязательная проверка ссылок перед публикацией (R-2)
- **Цель**: Предотвратить публикацию контента с неработающими ссылками, которые не могут быть автоматически исправлены.
- **Изменения**: Интеграция логики проверки в команду `publish`, прерывание процесса при обнаружении неисправимых ссылок.

### 3.3. Автоматическое исправление ссылок (R-3)
- **Цель**: Автоматически исправлять ссылки с высокой степенью уверенности (один однозначный вариант).
- **Изменения**: Использование существующего `AutoRepairer` (который был создан ранее) для выполнения неинтерактивного исправления. Повторная проверка после исправления.

### 3.4. Управление поведением (R-4)
- **Цель**: Предоставить пользователю контроль над функционалом проверки и авто-исправления.
- **Изменения**: Добавление флагов `--no-verify` и `--no-auto-repair` в команду `publish`.

## 4. Архитектурные решения

### 4.1. Введение Service Layer: PublicationWorkflowManager
- **Цель**: Инкапсулировать сложную логику публикации, проверки и исправления ссылок в отдельный сервис.
- **Преимущества**: Отделение бизнес-логики от CLI-интерфейса, повышение модульности и тестируемости.
- **Реализация**: Класс `PublicationWorkflowManager` будет оркестрировать взаимодействие между `PathResolver`, `LinkScanner`, `LinkVerifier`, `LinkResolver`, `AutoRepairer` и `EnhancedTelegraphPublisher`.

### 4.2. Роль существующих модулей
- `LinkScanner`, `LinkVerifier`, `LinkResolver` сохраняют свои текущие обязанности по сканированию, верификации и предоставлению предложений.
- `AutoRepairer` будет отвечать исключительно за применение исправлений к файлам.
- `EnhancedTelegraphPublisher` остается ответственным за взаимодействие с API Telegraph.

## 5. Зависимости
- Node.js `path` module (`resolve`, `dirname`, `join`, `relative`)
- `fs` module (`readFileSync`, `writeFileSync`)
- Существующие модули: `LinkScanner`, `LinkVerifier`, `LinkResolver`, `EnhancedTelegraphPublisher`, `ProgressIndicator`, `ConfigManager`, `MetadataManager`.
- Новый модуль: `PathResolver`, `PublicationWorkflowManager`.

## 6. Приемка
- См. Критерии приемки в `plan.md`.

## 7. Риски и нерешенные вопросы
- **Совместимость с `dry-run`**: Необходимо убедиться, что автоматическое исправление в режиме `dry-run` не вносит реальных изменений в файлы, а только симулирует их.
- **Производительность**: Для больших проектов с множеством файлов повторная проверка после автоматического исправления может быть ресурсоемкой. Необходим мониторинг производительности.
- **Конфликты с интерактивным режимом**: Убедиться, что новый автоматический режим не конфликтует с существующим интерактивным режимом `check-links --apply-fixes`.

---