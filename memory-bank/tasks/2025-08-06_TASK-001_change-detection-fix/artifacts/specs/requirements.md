# Change Detection System Requirements Specification

## Version 1.0  
**Task ID**: 2025-08-06_TASK-001_change-detection-fix  
**Created**: 2025-08-06_11-23  
**Status**: Active

## 1. Executive Summary

–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Telegraph Publisher —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø—Ä–æ–ø—É—Å–∫—É –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Ñ–ª–∞–≥–∞ `--force`. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (timestamp + hash) –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

## 2. Problem Statement from User Logs

### 2.1 Observed Issues

#### Issue 1: –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è
```
‚ÑπÔ∏è ‚≠êÔ∏è Skipping '01.md' (content hash already present)  
‚ÑπÔ∏è ‚≠êÔ∏è Skipping '00.—Å—é–∂–µ—Ç–Ω–∞—è –∞—Ä–∫–∞.1.md' (content hash already present)
‚ÑπÔ∏è ‚≠êÔ∏è Skipped 51 dependencies (already have content hash)
```

**Problem**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª —Ñ–∞–π–ª—ã, –Ω–æ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "content hash already present" –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.

#### Issue 2: –§–ª–∞–≥ --force –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
```
Generated code
‚ÑπÔ∏è ‚≠êÔ∏è Skipped 51 dependencies (already have content hash)
```

**Problem**: –î–∞–∂–µ —Å —Ñ–ª–∞–≥–æ–º `--force` –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "(already have content hash)" –≤–º–µ—Å—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

### 2.2 Root Cause Analysis  

1. **–ù–µ—Ç–æ—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏**: –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ *–Ω–∞–ª–∏—á–∏–µ* hash'–∞, –Ω–æ –Ω–µ *—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ*
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ timestamp –ø—Ä–æ–≤–µ—Ä–∫–∏**: –ù–µ—Ç –ø–µ—Ä–≤–∏—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ --force**: –§–ª–∞–≥ –Ω–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

## 3. Functional Requirements

### FR-001: –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ö–†–ò–¢–ò–ß–ù–û)
**–û–ø–∏—Å–∞–Ω–∏–µ**: –°–∏—Å—Ç–µ–º–∞ –î–û–õ–ñ–ù–ê –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–≤—É—Ö—ç—Ç–∞–ø–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
1. **–ü–µ—Ä–≤–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ mtime (–≤—Ä–µ–º—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞)
2. **–í—Ç–æ—Ä–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ content hash (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ mtime)

**Acceptance Criteria**:
- ‚úÖ –ü—Ä–∏ –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–º mtime —Ñ–∞–π–ª –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ —Ä–∞—Å—á—ë—Ç–∞ hash
- ‚úÖ –ü—Ä–∏ –∏–∑–º–µ–Ω–Ω–æ–º mtime –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—á—ë—Ç –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ hash
- ‚úÖ –§–∞–π–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ hash (–ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è mtime)

### FR-002: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Ñ–ª–∞–≥–∞ --force (–ö–†–ò–¢–ò–ß–ù–û)
**–û–ø–∏—Å–∞–Ω–∏–µ**: –§–ª–∞–≥ `--force` –î–û–õ–ñ–ï–ù –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –≤ —Ü–µ–ø–æ—á–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

**Acceptance Criteria**:
- ‚úÖ `--force` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ñ–∞–π–ª—É
- ‚úÖ `--force` —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏  
- ‚úÖ –ü—Ä–∏ `--force` –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ timestamp –∏ hash
- ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "Force republication" –≤–º–µ—Å—Ç–æ "already have content hash"

### FR-003: –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–ö–†–ò–¢–ò–ß–ù–û)
**–û–ø–∏—Å–∞–Ω–∏–µ**: –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ (–±–µ–∑ --force) —Å–∏—Å—Ç–µ–º–∞ –î–û–õ–ñ–ù–ê –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.

**Acceptance Criteria**:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –¥–µ—Ä–µ–≤–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (mtime + hash) –∫ –∫–∞–∂–¥–æ–º—É —Ñ–∞–π–ª—É
- ‚úÖ –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- ‚úÖ –ù–µ–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

### FR-004: –•—Ä–∞–Ω–µ–Ω–∏–µ timestamp –≤ –∫—ç—à–µ (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)
**–û–ø–∏—Å–∞–Ω–∏–µ**: –ö—ç—à –î–û–õ–ñ–ï–ù —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –∏ –¥–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

**Acceptance Criteria**:
- ‚úÖ –í –∫—ç—à–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è mtime –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫—ç—à–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∫—ç—à–∞ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

## 4. Technical Requirements

### TR-001: Performance Requirements
- **Primary Check**: Timestamp validation < 1ms per file
- **Secondary Check**: Hash calculation only when timestamp changed
- **Cache Migration**: Automatic, zero-downtime upgrade
- **Error Recovery**: < 100ms fallback for failed operations

### TR-002: API Requirements
```typescript
interface ChangeDetectionAPI {
  shouldRepublish(filePath: string, forceContext: ForceContext): Promise<RepublishDecision>;
  validateWithResilience(filePath: string): Promise<ValidationResult>;
  propagateForceFlag(parentForce: boolean, depth: number): ForceContext;
}
```

### TR-003: Cache Schema Enhancement
```typescript
interface EnhancedCacheEntry {
  contentHash: string;
  anchors: string[];
  mtime: string;        // NEW: File modification time  
  createdAt: string;    // NEW: Entry creation timestamp
  version: string;      // NEW: Schema version for migration
}
```

## 5. Quality Requirements

### QR-001: Test Coverage Requirements
- **Unit Tests**: 85% minimum coverage –¥–ª—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
- **Integration Tests**: –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ user workflow
- **Regression Tests**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- **Performance Tests**: –í–∞–ª–∏–¥–∞—Ü–∏—è performance targets

### QR-002: Reliability Requirements  
- **Accuracy**: 100% —Ç–æ—á–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **Force Propagation**: 100% –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã --force —Ñ–ª–∞–≥–∞
- **Data Integrity**: 0% –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫—ç—à–∞
- **Error Handling**: Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### QR-003: Compatibility Requirements
- **Backward Compatibility**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫—ç—à-—Ñ–∞–π–ª–æ–≤
- **API Compatibility**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö CLI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
- **Node.js Compatibility**: –†–∞–±–æ—Ç–∞ —Å —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π Node.js
- **TypeScript Compatibility**: –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö API

## 6. User Experience Requirements

### UX-001: Informative Logging
```bash
# –ñ–µ–ª–∞–µ–º—ã–π –≤—ã–≤–æ–¥ –¥–ª—è --force
üîÑ FORCE: Republishing 'example.md' (force flag enabled)
üîÑ FORCE: Republishing dependency '01.md' (force propagated)

# –ñ–µ–ª–∞–µ–º—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞  
‚ö° UNCHANGED: Skipping 'example.md' (mtime: unchanged)
üîÑ CHANGED: Republishing 'modified.md' (content hash changed)
üìù TIMESTAMP: Checking 'touched.md' (mtime changed, hash unchanged)
```

### UX-002: Progress Indicators
- –ß—ë—Ç–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ "fast path" –∏ "validation path"  
- –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å –ø–æ –∫–∞–∂–¥–æ–º—É —Ñ–∞–π–ª—É

## 7. Success Metrics

### Primary Success Criteria:
1. **Accurate Detection**: –í—Å–µ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è
2. **Force Respect**: –§–ª–∞–≥ --force —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤ —Ü–µ–ø–æ—á–∫–µ
3. **Performance**: ‚â•99% —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç fast path (timestamp only)
4. **Zero Regression**: –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ workflow –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

### Secondary Success Criteria:
1. **User Satisfaction**: –ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
2. **Developer Experience**: –ß—ë—Ç–∫–∏–µ –ª–æ–≥–∏ –∏ error messages
3. **Maintainability**: –ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
4. **Extensibility**: –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –±—É–¥—É—â–∏–º enhancement'–∞–º

## 8. Implementation Constraints

### Technical Constraints:
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Telegraph Publisher
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TypeScript —Å —Å—Ç—Ä–æ–≥–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ public API
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö CLI —Ñ–ª–∞–≥–æ–≤

### Quality Constraints:
- –ö–æ–¥ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ vitest –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ –Ω–µ –º–µ–Ω–µ–µ 85%
- –í—Å–µ —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –Ω–∞ 100%

---

*–î–∞–Ω–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –±–∞–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —á—ë—Ç–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.* 