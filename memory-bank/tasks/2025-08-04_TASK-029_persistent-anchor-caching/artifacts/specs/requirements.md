# Техническая спецификация: Улучшение валидации ссылок с постоянным кэшированием якорей

**Задача:** `persistent-anchor-caching`
**Версия:** 2.0
**Дата:** 2025-08-04

## 1. Введение

Данная спецификация описывает реализацию системы постоянного кэширования якорей (`#anchor`) для утилиты `telegraph-publisher`. Цель — кардинально повысить производительность повторных проверок ссылок путем анализа только измененных файлов. Система будет использовать файловый кэш и механизм инвалидации на основе хэша содержимого.

## 2. Архитектурные изменения

1. **Новый компонент `AnchorCacheManager`:** Будет создан новый класс, отвечающий исключительно за управление файлом кэша якорей (`.telegraph-anchors-cache.json`).
2. **Рефакторинг `calculateContentHash`:** Функция вычисления хэша будет вынесена в `ContentProcessor` как статический метод для обеспечения общего доступа из разных частей приложения.

## 3. Структура файла кэша

Будет создан новый файл `.telegraph-anchors-cache.json` в директории, из которой запускается команда.

**Структура `.telegraph-anchors-cache.json`:**
```json
{
  "version": "1.0.0",
  "createdAt": "2024-08-05T12:00:00.000Z",
  "anchors": {
    "/path/to/project/docs/guide.md": {
      "contentHash": "sha256_hash_of_content_without_metadata",
      "anchors": [
        "Introduction",
        "Setup",
        "Advanced-Usage"
      ]
    },
    "/path/to/project/api/reference.md": {
      "contentHash": "another_sha256_hash",
      "anchors": [
        "Endpoint-1",
        "Endpoint-2"
      ]
    }
  }
}
```

## 4. Компоненты реализации

### 4.1. AnchorCacheManager

**Файл:** `src/cache/AnchorCacheManager.ts`

**Основные методы:**
- `loadCache()`: Загрузка кэша из файла с обработкой ошибок
- `saveCache()`: Сохранение кэша в файл
- `getAnchorsIfValid(filePath, currentContentHash)`: Получение якорей из кэша если хэш совпадает
- `updateAnchors(filePath, newContentHash, newAnchors)`: Обновление записи в кэше

**Особенности:**
- Версионирование кэша для совместимости
- Автоматическое создание нового кэша при повреждении
- Обработка ошибок ввода-вывода
- Оптимизированное JSON-форматирование

### 4.2. ContentProcessor Enhancement

**Изменения в:** `src/content/ContentProcessor.ts`

**Новый метод:**
```typescript
public static calculateContentHash(content: string): string
```

**Функциональность:**
- Вычисление SHA-256 хэша содержимого
- Обработка ошибок с безопасным fallback
- Оптимизация для больших файлов

### 4.3. LinkVerifier Integration

**Изменения в:** `src/links/LinkVerifier.ts`

**Новая логика:**
1. При проверке якоря: запрос кэшированных данных
2. Сравнение хэша текущего содержимого с кэшированным
3. При несовпадении: повторный анализ и обновление кэша
4. Сохранение кэша после обработки файла

## 5. Алгоритм работы

### 5.1. Проверка ссылки с якорем

1. **Проверка существования файла**: Если файл не существует → ошибка
2. **Вычисление хэша**: Читается содержимое, удаляются метаданные, вычисляется SHA-256
3. **Проверка кэша**: `AnchorCacheManager.getAnchorsIfValid(filePath, currentHash)`
4. **Обработка результата**:
   - Если кэш валиден → использование кэшированных якорей
   - Если кэш невалиден → повторный анализ файла и обновление кэша
5. **Валидация якоря**: Проверка наличия декодированного фрагмента в списке якорей
6. **Генерация ошибок**: При отсутствии якоря → список доступных якорей + предложения

### 5.2. Инвалидация кэша

**Критерии инвалидации:**
- Несовпадение хэша содержимого
- Отсутствие записи для файла
- Повреждение структуры кэша
- Несовместимая версия кэша

**Процесс обновления:**
1. Чтение файла и удаление метаданных
2. Извлечение якорей через regex анализ заголовков
3. Генерация slug для каждого заголовка
4. Обновление записи в кэше
5. Немедленное сохранение кэша

## 6. Критерии приемки

### 6.1. Функциональные требования

- [ ] При запуске команд `check-links` или `publish` создается/обновляется `.telegraph-anchors-cache.json`
- [ ] Система вычисляет `contentHash` для каждого проверяемого файла
- [ ] При совпадении хэша якоря берутся из кэша без чтения файла
- [ ] При несовпадении хэша файл анализируется заново и кэш обновляется
- [ ] Сообщения об ошибках корректно отображают список доступных якорей
- [ ] Система gracefully fallback при повреждении кэша

### 6.2. Производительность

- [ ] Значительное ускорение повторных проверок (>50% для проектов с >10 файлами)
- [ ] Минимальные накладные расходы при первом запуске
- [ ] Эффективное использование памяти при работе с большими проектами

### 6.3. Качество кода

- [ ] 85% минимальное покрытие тестами
- [ ] 100% успешность тестов
- [ ] Соответствие существующим код-стайл требованиям
- [ ] Полная обратная совместимость

## 7. Структура тестирования

### 7.1. Unit Tests

- `AnchorCacheManager.test.ts`: Тестирование всех методов кэш-менеджера
- `ContentProcessor.test.ts`: Обновление для тестирования `calculateContentHash`
- `LinkVerifier.test.ts`: Обновление для тестирования интеграции с кэшем

### 7.2. Integration Tests

- Тестирование полного цикла: создание кэша → проверка ссылок → обновление кэша
- Тестирование инвалидации при изменении файлов
- Тестирование recovery при повреждении кэша

### 7.3. Performance Tests

- Бенчмарки до и после внедрения кэширования
- Тестирование на больших проектах (>100 файлов)
- Измерение времени первого запуска vs повторных запусков

## 8. Миграционная стратегия

### 8.1. Backward Compatibility

- Система работает без изменений для пользователей
- Кэш создается автоматически при первом запуске
- Отсутствие кэша не влияет на функциональность

### 8.2. Rollout Plan

1. **Phase 1**: Реализация `AnchorCacheManager` и `ContentProcessor` изменений
2. **Phase 2**: Интеграция в `LinkVerifier` с обширным тестированием
3. **Phase 3**: Performance тестирование и оптимизация
4. **Phase 4**: Документация и релиз

## 9. Риски и митигация

### 9.1. Потенциальные риски

- **Повреждение кэша**: Mitigation через graceful fallback
- **Расхождение данных**: Mitigation через строгую валидацию хэшей
- **Производительность первого запуска**: Acceptable trade-off для долгосрочной выгоды

### 9.2. Мониторинг

- Логирование операций с кэшем
- Метрики hit/miss ratio
- Отслеживание размера кэш-файла

## 10. Заключение

Данная спецификация обеспечивает четкий план реализации системы постоянного кэширования якорей, который значительно улучшит пользовательский опыт при работе с большими проектами, сохраняя при этом надежность и точность существующей системы валидации ссылок.