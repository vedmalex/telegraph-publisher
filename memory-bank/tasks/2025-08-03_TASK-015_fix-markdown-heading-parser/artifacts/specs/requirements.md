# Техническая Спецификация: Исправление Парсинга Заголовков Markdown

**ID Задачи:** `FIX-PARSER-001`
**Дата:** `2025-08-03`
**Автор:** `External Agent (Technical Specs)`
**Статус:** `Готово к Реализации`

## 1. Формулировка Проблемы

Конвертер Markdown в TelegraphNode неправильно парсит заголовки, которые начинаются с номера, такие как `## 1. Заголовок Раздела`. Вместо создания элемента заголовка (`h3`), он неправильно интерпретирует строку как элемент упорядоченного списка (`ol` > `li`), удаляя номер и обрабатывая остальной текст как содержимое списка.

## 2. Анализ Основной Причины

Основная причина этого бага находится в функции `convertMarkdownToTelegraphNodes` в файле `src/markdownConverter.ts`. Главный цикл функции проверяет блочные элементы Markdown в определенном порядке. В настоящее время проверка элементов списка происходит перед проверкой заголовков.

Регулярное выражение для элементов списка (`/(\d+)\.\s+(.*)/`) успешно соответствует паттерну пронумерованного заголовка, что приводит к преждевременной и неправильной обработке.

**Проблемная Логика Кода:**
```typescript
// в src/markdownConverter.ts

// ... внутри цикла for ...

// Обработка списков (ЭТО ПРОВЕРЯЕТСЯ СЛИШКОМ РАНО)
const listItemMatch = line.match(/^(-|\*)\s+(.*)|(\d+)\.\s+(.*)/);
if (listItemMatch) {
    // ... выполняется неправильная логика обработки списка для пронумерованных заголовков
    continue;
}

// ... больше проверок ...

// Обработка заголовков (ЭТО ПРОВЕРЯЕТСЯ СЛИШКОМ ПОЗДНО)
const headingMatch = line.match(/^(#+)\s*(.*)/);
if (headingMatch?.[1] && headingMatch[2] !== undefined) {
    // ... этот блок никогда не достигается для пронумерованных заголовков
}
```

## 3. Предлагаемое Решение

Основное решение заключается в переупорядочивании условных проверок в главном цикле обработки функции `convertMarkdownToTelegraphNodes`. Логика для обнаружения и парсинга заголовков должна выполняться **перед** логикой для обнаружения и парсинга элементов списка. Это гарантирует, что более специфичные паттерны (например, `## ...`) сопоставляются первыми.

Дополнительно, регулярное выражение для сопоставления списков может быть сделано более надежным путем привязки его к началу строки.

## 4. Детали Реализации

**Файл для Изменения:** `src/markdownConverter.ts`
**Функция для Изменения:** `convertMarkdownToTelegraphNodes`

### A. Переупорядочить Условные Блоки

Разработчик должен переместить весь блок `// Handle headings` так, чтобы он был перед блоком `// Handle lists`.

**Код - До Изменений:**
```typescript
// ... внутри цикла for в convertMarkdownToTelegraphNodes ...

// ... (обработка таблиц и blockquote) ...

// Handle lists
const listItemMatch = line.match(/^(-|\*)\s+(.*)|(\d+)\.\s+(.*)/);
if (listItemMatch) {
    // ... логика списка ...
    continue;
} else if (inList) {
    // ... логика закрытия списка ...
}

// Handle headings
const headingMatch = line.match(/^(#+)\s*(.*)/);
if (headingMatch?.[1] && headingMatch[2] !== undefined) {
    // ... логика заголовков ...
    continue;
}

// ... (остальная часть функции) ...
```

**Код - После Изменений:**
```typescript
// ... внутри цикла for в convertMarkdownToTelegraphNodes ...

// ... (обработка таблиц и blockquote) ...

// Handle headings (ПЕРЕМЕЩЕНО ВВЕРХ)
const headingMatch = line.match(/^(#+)\s*(.*)/);
if (headingMatch?.[1] && headingMatch[2] !== undefined) {
    // ... (существующая логика заголовков остается неизменной) ...
    continue;
}

// Handle lists (ТЕПЕРЬ ПОСЛЕ ЗАГОЛОВКОВ)
const listItemMatch = line.match(/^(-|\*)\s+(.*)|(\d+)\.\s+(.*)/);
if (listItemMatch) {
    // ... (существующая логика списков остается неизменной) ...
    continue;
} else if (inList) {
    // ... (существующая логика закрытия списков остается неизменной) ...
}

// ... (остальная часть функции) ...
```

### B. (Рекомендуется) Улучшить Regex Списков

Для предотвращения будущих проблем рекомендуется сделать регулярное выражение списков более специфичным, обеспечив соответствие с начала строки, позволяя дополнительные пробелы в начале.

**Regex - До:**
```typescript
const listItemMatch = line.match(/^(-|\*)\s+(.*)|(\d+)\.\s+(.*)/);
```

**Regex - После (Рекомендуется):**
```typescript
const listItemMatch = line.match(/^\s*(-|\*)\s+(.*)|^\s*(\d+)\.\s+(.*)/);
```

## 5. Критерии Приемки

1. Строка Markdown, такая как `## 1. Знакомство с участниками` из `class001.structured.md`, должна быть правильно распарсена в следующую структуру JSON:
   ```json
   {
     "tag": "h3",
     "children": [
       "1. Знакомство с участниками"
     ]
   }
   ```
2. Стандартный элемент упорядоченного списка (например, `1. First item`) должен по-прежнему правильно парситься как элемент `ol > li`.
3. Стандартный элемент неупорядоченного списка (например, `- First item`) должен по-прежнему правильно парситься как элемент `ul > li`.
4. Запуск конвертации на `class001.structured.md` должен создать JSON файл, где все пронумерованные заголовки `##` правильно представлены как теги `h3`.

## 6. План Тестирования

1. **Создать новый unit тест** в `src/markdownConverter.test.ts` для специфичной валидации этого исправления.
2. Тест должен принимать Markdown строку типа `## 1. My Numbered Heading` как вход.
3. Утверждать, что вывод является единственным объектом `TelegraphNode` с `tag: "h3"` и его массив `children` содержит полный текст `"1. My Numbered Heading"`.
4. Утверждать, что вывод **не является** тегом `ol`.
5. Обеспечить, что все существующие тесты, особенно те, что для упорядоченных и неупорядоченных списков, продолжают проходить после изменения.

## 7. Техническая Документация

### Текущая Архитектура Парсера
```
convertMarkdownToTelegraphNodes()
├── Проверка таблиц
├── Проверка blockquote
├── Проверка списков ← ПРОБЛЕМА: слишком рано
├── Проверка заголовков ← РЕШЕНИЕ: переместить сюда
└── Проверка обычного текста
```

### Исправленная Архитектура Парсера
```
convertMarkdownToTelegraphNodes()
├── Проверка таблиц
├── Проверка blockquote
├── Проверка заголовков ← ИСПРАВЛЕНО: первая проверка
├── Проверка списков ← ИСПРАВЛЕНО: после заголовков
└── Проверка обычного текста
```

## 8. Влияние и Риски

**Положительное Влияние:**
- Правильный парсинг пронумерованных заголовков
- Лучшая структура документов
- Соответствие стандартам Markdown

**Потенциальные Риски:**
- Минимальные - изменение только порядка проверок
- Существующие тесты должны обеспечить отсутствие регрессии

**Стратегия Снижения Рисков:**
- Тщательное тестирование всех типов Markdown элементов
- Проверка совместимости с существующими документами
- Добавление специфичных тестов для edge cases