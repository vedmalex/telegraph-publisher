### **Спецификация правил генерации якорей (anchors) в Telegra.ph (Версия 2.0)**

Этот документ описывает точный алгоритм преобразования текста заголовка в якорную ссылку (`id` атрибут), используемый платформой Telegra.ph. Правила основаны на эмпирическом анализе страницы, опубликованной с помощью скрипта `scripts/research_anchors.ts`.

**Этот документ заменяет все предыдущие версии и предположения.**

---

#### **Точный алгоритм**

1.  **Исходный текст:** Берется полный текст заголовка "как есть" (`as-is`), включая все символы Markdown-форматирования (`*`, `_`, `[`, `]`, `(`, `)`, `` ` ``).
2.  **Очистка пробелов:** Удаляются начальные и конечные пробелы (`trim`).
3.  **Удаление символов:** Из текста удаляются **только** символы угловых скобок (`<` и `>`).
4.  **Замена пробелов:** Все символы пробела (` `) заменяются на дефисы (`-`).
5.  **Сохранение остального:** Все остальные символы, включая кириллицу, знаки препинания, спецсимволы и символы Markdown, **остаются без изменений**. Регистр символов **сохраняется**.

---

#### **Примеры преобразования**

| Исходный текст заголовка | Сгенерированный якорь | Примечание |
| :--- | :--- | :--- |
| `Title With Spaces` | `Title-With-Spaces` | Пробелы заменены, регистр сохранен. |
| `Заголовок с пробелами` | `Заголовок-с-пробелами` | Кириллица и регистр сохраняются. |
| `**Bold Title**` | `**Bold-Title**` | Символы Markdown (`**`) **не** удаляются. |
| `[Link Title](url)` | `[Link-Title](url)` | Символы ссылки **не** удаляются. |
| `Title with < > symbols` | `Title-with--symbols` | Символы `<` и `>` были удалены. |
| `Аналогия «Дерево цивилизации» (из комментария к ШБ 1.1.4)` | `Аналогия-«Дерево-цивилизации»-(из-комментария-к-ШБ-1.1.4)` | Сложные знаки препинания сохраняются. |

---

#### **Ключевые принципы**

*   **Регистр сохраняется.** (`Case-Sensitive`)
*   **Markdown-форматирование НЕ удаляется.**
*   **Только пробелы заменяются на дефисы.**
*   **Почти все спецсимволы сохраняются,** за исключением `<` и `>`.

---

#### **Псевдокод для реализации**

```javascript
function generateTelegraphAnchor(headerText: string): string {
  // 1. Взять исходный текст и очистить пробелы по краям
  let anchor = headerText.trim();

  // 2. Удалить символы < и >
  anchor = anchor.replace(/[<>]/g, '');

  // 3. Заменить все пробелы на дефисы
  anchor = anchor.replace(/ /g, '-');

  // 4. Вернуть результат. Никаких других преобразований не требуется.
  return anchor;
}
```

Этот алгоритм должен быть реализован в `LinkVerifier.ts` и `markdownConverter.ts` для обеспечения консистентности при валидации ссылок и генерации оглавления.